@(username: String)(implicit request: RequestHeader)

@sidebar = {

<div class="well">
    <ul class="nav nav-tabs">
        <li class="active"><a href="#home" data-toggle="tab"><i class="icon-twitter-sign"></i> Twitter</a></li>
        <li><a href="#profile" data-toggle="tab"><i class="icon-facebook-sign"></i> Facebook</a></li>
    </ul>
    <div id="myTabContent" class="tab-content">
        <div class="tab-pane active in" id="home">
            <form id="tab" class="form-search">
                <span class="label label-important">Language</span>
                <select class="span7" id="filterByLanguage">
                    <option selected>No filter</option>
                    <option value="es">Spanish</option>
                    <option value="en">English</option>
                    <option value="fr">French</option>
                    <option value="de">German</option>
                    <option value="it">Italian</option>
                </select>

                <div class="side_component">
                    <span class="label label-important">Followers</span>
                    <select class="span7" id="filterByFollowers">
                        <option selected>No filter</option>
                        <option value="1">More than 500</option>
                        <option value="2">More than 5.000</option>
                        <option value="3">More than 50.000</option>
                        <option value="4">More than 1000.000</option>
                    </select>
                </div>
                <div class="side_component">
                    <span class="label label-important ">Location</span>
                    <select class="span7" id="filterByLocation">
                        <option selected>No filter</option>
                        <option value="GB">GB</option>
                        <option value="ES">Spain</option>
                        <option value="FR">France</option>
                        <option value="DE">Germany</option>
                        <option value="IT">Italy</option>
                    </select>
                </div>
                <div class="input-append side_component">
                    <input id="filter" type="text" class="span8 search-query">
                    <button id="start" type="submit" class="btn btn-info custom">Search</button>
                    <button id="stop" class="btn btn-danger custom" type="submit">Stop</button>
                </div>
            </form>

        </div>
        <div class="tab-pane fade" id="profile">
            Under construction
        </div>
    </div>
</div>

<div class="well">
    <div id="loadingRecommendationMessage">
        <i class="icon-spinner icon-spin icon-large"></i><span> Recommendations in Real Time......</span>
        <hr>
    </div>

    <div>
        <div class="well" style="width:300px; padding: 8px 0;">
            <div style="overflow-y: scroll; overflow-x: hidden; height: 500px;">
                <ul id="recommendations" class="nav nav-list">
                </ul>
            </div>
        </div>
    </div>
</div>
<input id="currentFilter" type="hidden" name="currentFilter">

}

@main(Some(username))(sidebar) {
<div id="searchResults" class="well">
    <ul id="search-nav" class="nav nav-tabs"></ul>
    <div id="mySearchTabContent" class="tab-content"></div>
</div>


<script type="text/javascript" charset="utf-8">


    $(function () {

        $('#stop').hide()
        $('#recommendations').hide()
        $('#searchResults').hide()


        var WS = window['MozWebSocket'] ? MozWebSocket : WebSocket
        var chatSocket = new WS("@routes.Application.stream(username).webSocketURL()")

        var sendMessage = function () {
            chatSocket.send(JSON.stringify(
                    {text: $("#talk").val()}
            ))
            $("#talk").val('')
        }

        var receiveEvent = function (event) {
            var data = JSON.parse(event.data)

            // Handle errors
            if (data.error) {
                chatSocket.close()
                $("#onError span").text(data.error)
                $("#onError").show()
                return
            } else {
                $("#onChat").show()
            }

            // Create the message element
            if (data.recommendations != null) {
                $('#recommendations').show()
                var el = 'Alvaro'
                for (var i = 0; i < data.recommendations.length; i++) {
                    el = el + '<li><label class="tree-toggler nav-header">' + data.recommendations[i].language + '</label><ul class="nav nav-list tree">'
                    for (var j = 0; j < data.recommendations[i].candidates.length; j++) {
                        el = el + '<li><a href="#">' + data.recommendations[i].candidates[j] + '</a></li>'
                    }
                    el = el + '</ul></li><li class="divider"></li>'
                }
//                alert(data.recommendations[0].candidates[0])
//                $("#loadingRecommendationMessage").text(data.recommendations)
                $('#recommendations').append(el)

            }
            else if (data.tweet != null) {
                var el = $('<div class="well well-small" >' +
                        '<div class="row">' +
                        '<div class="span2 main_left_image"><img id="url" data-src=""></div>' +
                        '<div class="span2"><i class="icon-user"></i> <span id="tweeterUser"></span></div>' +
                        '<div class="span3"><span id="created_at"></span></div>' +
                        '<div class="span2"><i class="icon-comment"></i> <span id="lang"></span></div>' +
                        '<div class="span2"><strong><span>Followers: </span></strong><span id="followers"></span></div>' +
                        '</div>' +
                        '<div class="media">' +
//                        '<a class="pull-left" href="#">' +
//                        '<img id="url" class="media-object" data-src="">' +
//                        '</a>' +
                        '<div class="media-body"><br><i class="icon-twitter"></i>' +
                        '<span id="tweet"></span></div>' +
                        '</div></div>')


                $("#tweet", el).text(' ' + data.tweet)
                $("#created_at", el).text(data.created_at)
                $("#tweeterUser", el).text(data.tweeterUser)
                $("#followers", el).text(data.followers_count)
                $("#lang", el).text(data.lang)
                $("#url", el).attr("src", data.url)
                $('#twitter-' + $("#filter").val()).prepend(el)

            } else {
                var el = $('<div class="message"><span></span><p></p></div>')
                $("span", el).text(data.user)

                $("p", el).text(data.message)
                $(el).addClass(data.kind)
                if (data.user == '@username') $(el).addClass('me')
                $('#twitter').prepend(el)
            }

        }

        chatSocket.onmessage = receiveEvent

    })


    jQuery("#start").click(
            function () {
                $('#searchResults').show()
                if ($("#currentFilter").val() != "") {
                    $('#li-tab-search-' + $("#currentFilter").val()).removeClass()
                    $("#Search" + $("#currentFilter").val()).removeClass()
                    $("#Search" + $("#currentFilter").val()).addClass("tab-pane fade")
                }
                $("#currentFilter").val($("#filter").val())

                var el1 = $('<li id="li-tab-search-' + $("#filter").val() + '"  class="active">' +
                        '<a id="tab-search" href="" data-toggle="tab"></a></li>')
                $("#tab-search", el1).text($("#filter").val())
                $("#tab-search", el1).attr("href", '#Search' + $("#filter").val())
                $('#search-nav').append(el1)

                var el2 = $('<div class="tab-pane active in" id="Search' + $("#filter").val() + '">' +
                        '<div class="span3"><span class="label label-info">Language</span><span> ' + $("#filterByLanguage option:selected").text() + '</span></div>' +
                        '<div class="span4"><span class="label label-info">Followers</span><span> ' + $("#filterByFollowers option:selected").text() + '</span></div>' +
                        '<div class="span3"><span class="label label-info">Location</span><span> ' + $("#filterByLocation option:selected").text() + '</span></div>' +
                        '<div class="span2"><i class="icon-trash"></i><span> Delete</span></div>' +
                        '<div id="onChat" class="row" style="display: block;">' +
                        '<div class="span13 main_left_component" id="main">' +
                        '<div id="twitter-' + $("#filter").val() + '"></div>' +
                        '</div></div></div></div>')
                $('#mySearchTabContent').append(el2)

                $('#stop').show()
                $('#start').hide()
                $('#filter').attr('disabled', 'disabled')
                $('#filterByLanguage').attr('disabled', 'disabled')
                $('#filterByFollowers').attr('disabled', 'disabled')
                $('#filterByLocation').attr('disabled', 'disabled')

//                if ($("#filterByLanguage").val() == 'No filter')
//                    $.get("@routes.Application.startFilter()", {'username': "@username", 'filter': $("#filter").val()}, function (data) {
//                        $('#perete').html(data);
//                    });
//                else
                $.get("@routes.Application.startFilter()", {'username': "@username",
                    'filter': $("#filter").val(),
                    'followers': $("#filterByFollowers").val(),
                    'language': $("#filterByLanguage").val(),
                    'location': $("#filterByLocation").val()
                }, function (data) {
                    $('#perete').html(data);
                });

                return false;
            }
    )

    jQuery("#stop").click(
            function () {
                $('#start').show()
                $('#filter').removeAttr('disabled')
                $('#filterByLanguage').removeAttr('disabled')
                $('#filterByFollowers').removeAttr('disabled')
                $('#filterByLocation').removeAttr('disabled')

                $('#stop').hide()
                $.get("@routes.Application.stopFilter()", {
                    'username': "@username",
                    'filter': $("#filter").val(),
                    'location': $("#filterByLocation").val()}, function (data) {
                    $('#perete').html(data);
                });
                return false;
            }
    )

    $(document.body).on("click", "label.tree-toggler", function () {
        $(this).parent().children('ul.tree').toggle(300);
    })


</script>

}



